import os
from django.conf import settings
from django.core.files.storage import FileSystemStorage
import matplotlib.pyplot as plt

# The aim is to update each image generated by the system so as to have new content in the frontend
# independently of each other, also in the database.

def save_plot(ticker, suffix):
    # Search for the last number in existing images
    directory = os.path.join(settings.MEDIA_ROOT)
    existing_files = [f for f in os.listdir(directory) if f.startswith(f"{ticker}_{suffix}")]
    
    # Finds the last number associated with the ticker
    last_number = 0
    for filename in existing_files:
        parts = filename.split(f'_{suffix}')  # extract number from file name
        if len(parts) > 1:
            try:
                num = int(parts[1].split('.')[0])  # convert the numeric part to integer to obtain the image number
                if num > last_number:
                    last_number = num
            except ValueError:
                continue

    # Generates the file name with the following number
    plot_img_path = f"{ticker}_{suffix}{last_number + 1}.png"  # let's create a new file name with the following number 
    image_path = os.path.join(directory, plot_img_path)
    
    plt.savefig(image_path)
    plt.close()
    
    # Returns a clickable URL to the image
    image_url = settings.MEDIA_URL + plot_img_path
    return image_url
